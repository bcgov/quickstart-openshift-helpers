# Setting Up a Vanity or Custom URL

## Table of Contents
- [Generating a Request](#generating-a-request)
- [Installing the Certificate](#installing-the-certificate)
- [Backing Up Certificates](#backing-up-certificates)
- [Reinstall and Renewals](#reinstall-and-renewals)
- [Reference](#reference)

## Generating a Request

Ticketing and administrative steps are for the Natural Resources only.  Other ministries will have their own processes.

Steps:
1. Create a certificate signing request (CSR) and private key using `./csr_generator.sh`.
   - This generates both `<DOMAIN>.csr` and `<DOMAIN>.key` files
   - Example: Running `./csr_generator.sh example.nrs.gov.bc.ca` creates `example.nrs.gov.bc.ca.csr` and `example.nrs.gov.bc.ca.key`
2. Create a [JIRA issue](https://apps.nrs.gov.bc.ca/int/jira/secure/CreateIssue!default.jspa).
3. Provide details, which are glossed over in the script from step 1.
4. Attach the CSR file generated in step 1.
5. Wait, answering questions or following up as necessary.

## Installing the Certificate

These steps should work for any OpenShift (and hopefully Kubernetes!) setup.  Certificates must have already been provided by your ministry's administrators.

### Preparing Certificate Files

After receiving certificates from your administrators (via JIRA response), you need to prepare the files with the correct naming:

**Files you should have received (in a .zip file):**
- End-entity certificate as `<DOMAIN>.pem` (PEM format)
- Primary CA certificate files (e.g. `1-OV TLS CA 2.txt`)
- Unnecessary CA certificates (`2-Sectigo Public Server Root.txt`, `3-User Trusted Root.txt`)

**Files you already have:**
- `<DOMAIN>.key` - Generated by `csr_generator.sh` (private key - **required**, must be retained)
- `<DOMAIN>.csr` - Generated by `csr_generator.sh` (not needed for installation; recommended to retain for renewals)

**File preparation required:**
1. Extract the certificate from the received .zip file
   - The end-entity certificate should be named `<DOMAIN>.pem` (e.g., `example.nrs.gov.bc.ca.pem`)
2. Extract the intermediate CA certificate to `<DOMAIN>.ca-cert`
   - Use `1-OV TLS CA 2.txt` (the certificate that directly issued your end-entity certificate)
   - Example: `cp "1-OV TLS CA 2.txt" "example.nrs.gov.bc.ca.ca-cert"`

**Files required for installation:**
- `<DOMAIN>.pem` - End-entity certificate (contains public key, identity, and CA signature)
- `<DOMAIN>.key` - Private key (matches the public key in the certificate)
- `<DOMAIN>.ca-cert` - CA certificate chain (for validation)

**Note:** The CSR file is not used during installation. For certificate renewals, you can generate a new CSR using the same private key, or reuse the original CSR if you want to ensure identical certificate attributes. **Most importantly, retain your private key file** - it's required to use the certificate and cannot be regenerated. The CSR is recommended but not absolutely required, as you can generate a new one when needed.

### Installation Steps

1. Ensure all required files are prepared with correct naming (see above)
2. Login to [OpenShift](https://console.apps.silver.devops.gov.bc.ca/k8s/cluster/projects)
3. Switch to the appropriate namespace: `oc project <namespace>`
4. Install the certificate using `./install_cert.sh`

## Backing Up Certificates

Route certificates can be lost if routes are accidentally deleted. To protect against this, you can back up your route certificates to OpenShift secrets.

### Manual Backup

Use the `backup_certs.sh` script to manually back up certificates from routes to secrets:

```bash
# Backup all routes in the current namespace
./backup_certs.sh

# Backup a specific route
./backup_certs.sh --route myapp-vanity

# Backup routes matching a label
./backup_certs.sh --label "app=myapp"

# Use a custom prefix for backup secrets (default is "backup")
./backup_certs.sh --prefix "cert-backup"

# Preview what would be backed up (dry run)
./backup_certs.sh --dry-run
```

The script will create secrets named `<prefix>-<route-name>-tls` containing:
- `tls.crt` - The certificate
- `tls.key` - The private key
- `ca.crt` - The CA certificate (if present)
- `destination-ca.crt` - The destination CA certificate (if present for re-encrypt routes)

Each backup secret includes annotations tracking the source route, backup timestamp, and TLS termination type.

### Automated Scheduled Backups

#### Option 1: GitHub Actions Workflow

Use the reusable workflow to schedule automated backups via GitHub Actions:

```yaml
name: Scheduled Certificate Backup
on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    uses: bcgov/quickstart-openshift-helpers/.github/workflows/backup-certs.yml@v1.0.0
    secrets:
      oc_token: ${{ secrets.OC_TOKEN }}
      oc_namespace: ${{ secrets.OC_NAMESPACE }}
    with:
      oc_server: https://api.silver.devops.gov.bc.ca:6443
      # Optional: backup only specific routes
      # route: myapp-vanity
      # label: "app=myapp"
      prefix: backup
```

#### Option 2: OpenShift CronJob

Deploy a CronJob directly in your OpenShift namespace for automated backups:

```bash
# Deploy the CronJob with default settings (runs daily at 2 AM)
oc process -f cronjob-template.yaml | oc apply -f -

# Customize the schedule and other parameters
oc process -f cronjob-template.yaml \
  -p SCHEDULE="0 2 * * *" \
  -p SECRET_PREFIX="backup" \
  -p LABEL_SELECTOR="app=myapp" \
  | oc apply -f -

# Backup only a specific route
oc process -f cronjob-template.yaml \
  -p ROUTE_NAME="myapp-vanity" \
  | oc apply -f -
```

The CronJob template creates:
- A ServiceAccount with permissions to read routes and manage secrets
- A Role and RoleBinding for the required permissions
- A ConfigMap containing the backup script
- A CronJob that runs on the specified schedule

### Restoring from Backup

To restore a certificate from a backup secret to a route:

```bash
# Extract certificate data from backup secret
ROUTE_NAME="myapp-vanity"
oc get secret backup-${ROUTE_NAME}-tls -o jsonpath='{.data.tls\.crt}' | base64 -d > ${ROUTE_NAME}.pem
oc get secret backup-${ROUTE_NAME}-tls -o jsonpath='{.data.tls\.key}' | base64 -d > ${ROUTE_NAME}.key
oc get secret backup-${ROUTE_NAME}-tls -o jsonpath='{.data.ca\.crt}' | base64 -d > ${ROUTE_NAME}.ca-cert

# Reinstall the certificate using the install_cert.sh script
./install_cert.sh
```

### Managing Backup Secrets

```bash
# List all backup secrets
oc get secrets -l backup.openshift.io/type=route-tls

# View details of a backup secret
oc describe secret backup-myapp-vanity-tls

# Delete old backups (if needed)
oc delete secret backup-myapp-vanity-tls
```

## Reinstall and Renewals

For reinstallation or recovery of deleted OpenShift routes, you need:
- `<DOMAIN>.pem` - End-entity certificate
- `<DOMAIN>.key` - Private key
- `<DOMAIN>.ca-cert` - CA certificate chain

For certificate renewals, you need:
- `<DOMAIN>.key` - Private key (required - must match the original certificate)
- `<DOMAIN>.csr` - Certificate signing request (recommended to retain, but you can generate a new one using the same private key)

Use `./install_cert.sh` as required for reinstallation or after renewals.


## Reference

[How do I get a custom vanity URL for my application in Openshift?](https://stackoverflow.developer.gov.bc.ca/questions/172/176)

[Creating government web presences](https://www2.gov.bc.ca/gov/content/governments/services-for-government/service-experience-digital-delivery/digital-delivery/web-property-process)

[Order Domain Name Registration and Domain Name Services Article](https://ociomysc.service-now.com/sp?id=ocio_sr_kb_article_view&sysparm_article=KB0031620&sys_kb_id=c66a12a8db4c0510fa8619381396197f&spa=1)

[OCP 4 platform network topology](https://digital.gov.bc.ca/cloud/services/private/internal-resources/topology/)

[SSL Certificates for https://system.eao.gov.bc.ca/](https://apps.nrs.gov.bc.ca/int/jira/browse/SD-96171)

[How to update route TLS certificate from CLI?](https://stackoverflow.developer.gov.bc.ca/questions/239)
