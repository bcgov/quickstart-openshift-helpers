# Setting Up a Vanity or Custom URL

## Generating a Request

Ticketing and administrative steps are for the Natural Resources only.  Other ministries will have their own processes.

Steps:
1. Create a certificate signing request (CSR) and private key using `./csr_generator.sh`.
   - This generates both `<DOMAIN>.csr` and `<DOMAIN>.key` files
   - Example: Running `./csr_generator.sh example.nrs.gov.bc.ca` creates `example.nrs.gov.bc.ca.csr` and `example.nrs.gov.bc.ca.key`
2. Create a [JIRA issue](https://apps.nrs.gov.bc.ca/int/jira/secure/CreateIssue!default.jspa).
3. Provide details, which are glossed over in the script from step 1.
4. Attach the CSR file generated in step 1.
5. Wait, answering questions or following up as necessary.

## Installing the Certificate

These steps should work for any OpenShift (and hopefully Kubernetes!) setup.  Certificates must have already been provided by your ministry's administrators.

### Preparing Certificate Files

After receiving certificates from your administrators (via JIRA response), you need to prepare the files with the correct naming:

**Files you should have received (in a .zip file):**
- End-entity certificate as `<DOMAIN>.pem` (PEM format)
- Primary CA certificate files (e.g. `1-OV TLS CA 2.txt`)
- Unnecessary CA certificates (`2-Sectigo Public Server Root.txt`, `3-User Trusted Root.txt`)

**Files you already have:**
- `<DOMAIN>.key` - Generated by `csr_generator.sh` (private key - **required**, must be retained)
- `<DOMAIN>.csr` - Generated by `csr_generator.sh` (not needed for installation; recommended to retain for renewals)

**File preparation required:**
1. Extract the certificate from the received .zip file
   - The end-entity certificate should be named `<DOMAIN>.pem` (e.g., `example.nrs.gov.bc.ca.pem`)
2. Extract the intermediate CA certificate to `<DOMAIN>.ca-cert`
   - Use `1-OV TLS CA 2.txt` (the certificate that directly issued your end-entity certificate)
   - Example: `cp "1-OV TLS CA 2.txt" "example.nrs.gov.bc.ca.ca-cert"`

**Files required for installation:**
- `<DOMAIN>.pem` - End-entity certificate (contains public key, identity, and CA signature)
- `<DOMAIN>.key` - Private key (matches the public key in the certificate)
- `<DOMAIN>.ca-cert` - CA certificate chain (for validation)

**Note:** The CSR file is not used during installation. For certificate renewals, you can generate a new CSR using the same private key, or reuse the original CSR if you want to ensure identical certificate attributes. **Most importantly, retain your private key file** - it's required to use the certificate and cannot be regenerated. The CSR is recommended but not absolutely required, as you can generate a new one when needed.

### Installation Steps

#### Option 1: Manual Installation (CLI)

1. Ensure all required files are prepared with correct naming (see above)
2. Login to [OpenShift](https://console.apps.silver.devops.gov.bc.ca/k8s/cluster/projects)
3. Switch to the appropriate namespace: `oc project <namespace>`
4. Install the certificate using `./install_cert.sh`

#### Option 2: Automated Installation (GitHub Workflow)

You can use GitHub Actions to manage routes automatically from GitHub secrets. This approach is useful for:
- Updating certificates without manual CLI access
- Automating certificate renewals
- Managing multiple environments consistently

**Setup:**
1. Store your certificates as GitHub secrets:
   - `CERTIFICATE` - End-entity certificate (.pem file content)
   - `PRIVATE_KEY` - Private key (.key file content)
   - `CA_CERTIFICATE` - CA certificate chain (.ca-cert file content)
   - `OC_TOKEN` - OpenShift token
   - `OC_NAMESPACE` - OpenShift namespace

2. Use the workflow in your repository:

```yaml
jobs:
  update-route:
    name: Update Route
    uses: bcgov/quickstart-openshift-helpers/.github/workflows/route-manager.yml@vX.Y.Z
    secrets:
      oc_token: ${{ secrets.OC_TOKEN }}
      oc_namespace: ${{ secrets.OC_NAMESPACE }}
      certificate: ${{ secrets.CERTIFICATE }}
      private_key: ${{ secrets.PRIVATE_KEY }}
      ca_certificate: ${{ secrets.CA_CERTIFICATE }}
    with:
      domain: example.nrs.gov.bc.ca
      service: my-app-prod-frontend
      path: ""  # Optional: leave empty for root path
      oc_server: https://api.silver.devops.gov.bc.ca:6443
```

**Manual Trigger:**
You can also trigger the route manager directly from the GitHub Actions UI using `workflow_dispatch` by providing all required inputs.

## Reinstall and Renewals

For reinstallation or recovery of deleted OpenShift routes, you need:
- `<DOMAIN>.pem` - End-entity certificate
- `<DOMAIN>.key` - Private key
- `<DOMAIN>.ca-cert` - CA certificate chain

For certificate renewals, you need:
- `<DOMAIN>.key` - Private key (required - must match the original certificate)
- `<DOMAIN>.csr` - Certificate signing request (recommended to retain, but you can generate a new one using the same private key)

Use `./install_cert.sh` for manual reinstallation or after renewals, or use the GitHub workflow approach (see Installation Steps above) for automated updates.


## Reference

[How do I get a custom vanity URL for my application in Openshift?](https://stackoverflow.developer.gov.bc.ca/questions/172/176)

[Creating government web presences](https://www2.gov.bc.ca/gov/content/governments/services-for-government/service-experience-digital-delivery/digital-delivery/web-property-process)

[Order Domain Name Registration and Domain Name Services Article](https://ociomysc.service-now.com/sp?id=ocio_sr_kb_article_view&sysparm_article=KB0031620&sys_kb_id=c66a12a8db4c0510fa8619381396197f&spa=1)

[OCP 4 platform network topology](https://digital.gov.bc.ca/cloud/services/private/internal-resources/topology/)

[SSL Certificates for https://system.eao.gov.bc.ca/](https://apps.nrs.gov.bc.ca/int/jira/browse/SD-96171)

[How to update route TLS certificate from CLI?](https://stackoverflow.developer.gov.bc.ca/questions/239)
